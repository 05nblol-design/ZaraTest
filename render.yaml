# Render.com Deploy Configuration
# Zara Quality System - Sistema de Controle de Qualidade

services:
  - type: web
    name: zara-quality-system
    env: node
    plan: free
    region: oregon  # us-west-1 (mais prÃ³ximo do Brasil)
    buildCommand: |
      echo "ğŸ”§ Iniciando build do Zara Quality System..."
      echo "ğŸŒ NODE_ENV: $NODE_ENV"
      echo "ğŸ“ DiretÃ³rio atual: $(pwd)"
      echo "ğŸ”§ Node.js version: $(node --version)"
      echo "ğŸ“¦ NPM version: $(npm --version)"
      
      # Instalar dependÃªncias do backend
      echo "ğŸ“¦ Instalando dependÃªncias do backend..."
      npm ci --only=production
      echo "âœ… Backend dependencies installed"
      
      # Build do frontend
      echo "ğŸ”§ Building frontend..."
      cd client
      echo "ğŸ“ Frontend directory: $(pwd)"
      echo "ğŸ”§ Node.js version in client: $(node --version)"
      
      # Limpar cache do npm
      echo "ğŸ§¹ Clearing npm cache..."
      npm cache clean --force
      
      # Instalar dependÃªncias do frontend (incluindo devDependencies para build)
      echo "ğŸ“¦ Installing frontend dependencies..."
      npm install --verbose
      echo "âœ… Frontend dependencies installed"
      
      # Verificar se Vite foi instalado
      echo "ğŸ” Checking Vite installation..."
      npx vite --version || echo "âŒ Vite not found"
      
      # Verificar se todas as dependÃªncias estÃ£o instaladas
      echo "ğŸ“‹ Checking package.json dependencies..."
      npm ls --depth=0 || echo "âš ï¸ Some dependencies may be missing"
      
      # Executar build
      echo "ğŸ—ï¸ Running build..."
      echo "ğŸ“ Current directory: $(pwd)"
      echo "ğŸ“‚ Directory contents before build:"
      ls -la
      
      # Tentar build com npx vite diretamente
      echo "ğŸ”¨ Building with Vite..."
      npx vite build --mode production
      
      echo "ğŸ“‚ Directory contents after build:"
      ls -la
      echo "âœ… Frontend build completed"
      
      # Verificar se build foi bem-sucedido
      if [ ! -d "dist" ]; then
        echo "âŒ ERROR: dist directory not created"
        exit 1
      fi
      
      if [ ! -f "dist/index.html" ]; then
        echo "âŒ ERROR: index.html not found in dist"
        exit 1
      fi
      
      echo "âœ… Build verification passed"
      echo "ğŸ“‚ Dist contents:"
      ls -la dist/
      
      # Copiar arquivos do frontend para diretÃ³rio pÃºblico
      echo "ğŸ“ Copying frontend files to public directory..."
      mkdir -p ../public
      
      # Verificar se dist existe e tem conteÃºdo
      if [ ! -d "dist" ]; then
        echo "âŒ ERROR: dist directory does not exist"
        exit 1
      fi
      
      # Copiar todos os arquivos (incluindo ocultos)
      cp -r dist/. ../public/
      
      # Verificar se index.html foi copiado
      if [ ! -f "../public/index.html" ]; then
        echo "âŒ ERROR: index.html not found in public directory after copy"
        echo "ğŸ“‚ Public directory contents:"
        ls -la ../public/
        exit 1
      fi
      
      echo "âœ… Frontend files copied to public directory"
      
      # Voltar para diretÃ³rio raiz
      cd ..
      echo "ğŸ“‚ Public directory contents:"
      ls -la public/
      echo "ğŸš€ Build process completed successfully"
    startCommand: |
      echo "ğŸš€ Iniciando Zara Quality System..."
      echo "ğŸ“Š Modo: $NODE_ENV"
      echo "ğŸŒ Porta: $PORT"
      npm start
    healthCheckPath: /
    autoDeploy: true
    
    # ConfiguraÃ§Ãµes de performance
    numInstances: 1
    
    # ConfiguraÃ§Ãµes para WebSocket/Socket.IO
    routes:
      - type: rewrite
        source: /socket.io/*
        destination: /socket.io/$1
    
    # Disco persistente para uploads
    disk:
      name: zara-uploads
      mountPath: /opt/render/project/src/uploads
      sizeGB: 1
    
    # VariÃ¡veis de ambiente
    envVars:
      # ConfiguraÃ§Ãµes do servidor
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      
      # ConfiguraÃ§Ãµes de log
      - key: LOG_LEVEL
        value: info
      
      # ConfiguraÃ§Ãµes JWT
      - key: JWT_EXPIRES_IN
        value: 24h
      
      # ConfiguraÃ§Ãµes de upload
      - key: MAX_FILE_SIZE
        value: 5242880  # 5MB
      - key: UPLOAD_PATH
        value: ./uploads
      
      # ConfiguraÃ§Ãµes CORS
      - key: CORS_ORIGIN
        value: https://zara-quality-system-2.onrender.com
      
      # URL do Frontend
      - key: FRONTEND_URL
        value: https://zara-quality-system-2.onrender.com
      
      # ConfiguraÃ§Ãµes de cache
      - key: CACHE_TTL
        value: 300  # 5 minutos
      
      # Timezone
      - key: TZ
        value: America/Sao_Paulo
      
      # ConfiguraÃ§Ãµes do sistema de chat
      - key: CHAT_ENABLED
        value: true
      - key: CHAT_MAX_MESSAGES
        value: 100
      - key: CHAT_MESSAGE_TTL
        value: 86400  # 24 horas
      
      # ConfiguraÃ§Ãµes Socket.IO
      - key: SOCKET_IO_ENABLED
        value: true
      - key: SOCKET_IO_CORS_ORIGIN
        value: https://zara-quality-system-2.onrender.com
      - key: SOCKET_IO_TRANSPORTS
        value: websocket,polling
      - key: SOCKET_IO_PING_TIMEOUT
        value: 60000
      - key: SOCKET_IO_PING_INTERVAL
        value: 25000
      
      # ConfiguraÃ§Ãµes do MongoDB Atlas
      - key: MONGODB_URI
        sync: false  # SerÃ¡ definida no painel do Render
      - key: MONGO_URI
        sync: false  # Fallback, serÃ¡ definida no painel do Render
      
      # ConfiguraÃ§Ãµes de seguranÃ§a
      - key: JWT_SECRET
        sync: false  # SerÃ¡ definida no painel do Render
      
      # âš ï¸ IMPORTANTES: Defina estas variÃ¡veis no painel do Render:
      # MONGODB_URI - String de conexÃ£o do MongoDB Atlas
      # MONGO_URI - String de conexÃ£o do MongoDB Atlas (fallback)
      # JWT_SECRET - Chave secreta para JWT (mÃ­nimo 32 caracteres)
      # Exemplo: mongodb+srv://user:pass@cluster.mongodb.net/zaradb
    
    # Headers de seguranÃ§a
    headers:
      # ProteÃ§Ã£o contra clickjacking
      - path: /*
        name: X-Frame-Options
        value: DENY
      
      # ProteÃ§Ã£o contra MIME sniffing
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      
      # PolÃ­tica de referrer
      - path: /*
        name: Referrer-Policy
        value: strict-origin-when-cross-origin
      
      # PolÃ­tica de permissÃµes
      - path: /*
        name: Permissions-Policy
        value: camera=(), microphone=(), geolocation=()
      
      # SeguranÃ§a de transporte
      - path: /*
        name: Strict-Transport-Security
        value: max-age=31536000; includeSubDomains
      
      # Cache para assets estÃ¡ticos
      - path: /css/*
        name: Cache-Control
        value: public, max-age=31536000
      
      - path: /js/*
        name: Cache-Control
        value: public, max-age=31536000
      
      - path: /images/*
        name: Cache-Control
        value: public, max-age=31536000

# ConfiguraÃ§Ãµes adicionais para monitoramento
# (DisponÃ­vel em planos pagos)
# alerts:
#   - type: cpu
#     threshold: 80
#   - type: memory
#     threshold: 80
#   - type: response_time
#     threshold: 5000